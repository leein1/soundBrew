<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>로그인</title>
    <link href="../css/login.css" rel="stylesheet">
</head>
<body>
<div layout:fragment="content">
    <div class="content-header">
        로그인
    </div>

    <div class="content-body">
        <form class="login-form" action="/login" method="post">
            <div class="input-group">
                <label for="email">이메일</label>
<!--                <input type="email" id="email" name="email" placeholder="이메일 입력" required>-->
                    <input type="text" id="email" name="username" placeholder="이메일 입력" required>
            </div>
            <div class="input-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" name="password" placeholder="비밀번호 입력" required>
            </div>

            <button type="submit">로그인</button>

            <label for="remember-me">자동 로그인</label>
            <input type="checkbox" id="remember-me" name="remember-me">
        </form>
    </div>

    <div class="content-footer">
        <a href="#" class="footer-link">비밀번호 찾기</a>

    </div>
</div>
</body>
<script layout:fragment="script" th:inline="javascript">
    console.log("loaded script..");


    //
    //     document.querySelector("#btn1").addEventListener("click",()=>{
    //     const data = {username:"test@test.com",password:"testTEST123!@#"}
    //
    //     axios.post("http://localhost:8080/generateToken", data).then(res => {
    //
    //     const accessToken = res.data.accessToken
    //     const refreshToken = res.data.refreshToken
    //
    //     localStorage.setItem("accessToken", accessToken)
    //     localStorage.setItem("refreshToken", refreshToken)
    //
    //     console.log(res.data.accessToken)
    // })
    // },false)

    document.querySelector("button[type='submit']").addEventListener("click", async (event) => {
        event.preventDefault(); // 폼의 기본 동작 막기

        // 사용자 입력 값 가져오기
        const username = document.querySelector("#email").value;
        const password = document.querySelector("#password").value;

        // 요청 데이터 구성
        const data = { username, password };

        try {
            // 토큰 요청
            const tokenResponse = await axios.post("http://localhost:8080/generateToken", data);
            const accessToken = tokenResponse.data.accessToken;
            const refreshToken = tokenResponse.data.refreshToken;

            // 토큰을 localStorage에 저장
            localStorage.setItem("accessToken", accessToken);
            localStorage.setItem("refreshToken", refreshToken);

            console.log("Access Token:", accessToken);
            console.log("Refresh Token:", refreshToken);

            // /myInfo로 GET 요청
            const myInfoResponse = await axios.get("http://localhost:8080/myInfo", {
                headers: {
                    Authorization: `Bearer ${accessToken}`
                }
            });

            console.log("My Info response:", myInfoResponse.data);

            // 서버에서 반환한 HTML을 현재 페이지에 렌더링
            // 이 부분이 없으면 화면 이동이 일어나지 않고, response로 myInfo.html의 내용이 반환만 됨
            // 현재 테스트를 위해서 /login 에서 로그인 성공시 바로 /myInfo로 요청을 보내도록 되어 있는데
            // 실제 환경에서는 이전에 어느 경로(ex - 내 정보보기)에서 /login으로 이동했는지 확인 후 로그인 성공시 이전 경로(내 정보보기)로 리다이렉트 필요
            // or 로그인 성공시 무조건 "/" 로 리다이렉트
            document.open();
            document.write(myInfoResponse.data);
            document.close();


        } catch (err) {
            console.error("Error:", err);
            alert("로그인 실패 또는 정보 요청 실패. 이메일과 비밀번호를 확인하세요.");
        }
    }, false);

</script>

</html>