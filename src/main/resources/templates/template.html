<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
        /* 기본 레이아웃 */
        .content {
          margin: 0 auto;
          max-width: 1200px;
        }
        .content-header {
          margin-top: 20px;
          height: 50px;
          font-size: 2rem;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .content-body {
          display: flex;
          gap: 20px;
          padding: 20px;
        }
        .question-list {
          display: flex;
          justify-content: center;
          align-items: stretch;
          width: 100%;
        }
        .linkDiv {
          display: flex;
          width: 100%;
          gap: 20px;
          padding: 10px;
        }
        /* 좌측(통계)와 우측(메뉴) 영역 */
        .statistics-section,
        .frequently-list {
          flex: 1 1 0;
          min-width: 0;
        }
        /* 자주 사용하는 메뉴 항목 */
        .frequently-list > li {
          border-radius: 100px;
          padding: 20px;
          margin-top: 40px;
          list-style: none;
          display: flex;
          align-items: center;
          justify-content: space-between;
          background-color: #fff;
          box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
          transition: background-color 0.3s ease;
        }
        .frequently-list > li:hover {
          background-color: rgb(227, 227, 227);
        }
        .main-text {
          font-size: 18px;
          font-weight: bold;
        }
        .sub-text {
          font-size: 14px;
          color: #5F6368;
        }
        /* 차트 선택 영역 */
        .chart-selector {
            margin-top:35px;
          margin-bottom: 20px;
        }
        .chart-selector button {
          background-color: #4CAF50;
          color: white;
          border: none;
          padding: 6px 12px;
          font-size: 0.9rem;
          border-radius: 4px;
          cursor: pointer;
          margin: 5px 5px 5px 0;
          transition: background-color 0.3s ease;
        }
        .chart-selector button.active {
          background-color: #2E7D32;
        }
        /* 카테고리별 영역 (기본적으로 숨김) */
        .category-section {
          display: none;
        }
        /* 기본 표시: 음원관련 영역 */
        #music-section {
          display: block;
        }
        /* 수정페이지 영역 숨김 */
        .frequently-list {
          display: none;
        }
        /* 차트 그룹 컨테이너: grid로 2열 배치 */
        .chart-group-container {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 20px;
          width: 100%;
        }
        @media (max-width: 768px) {
            .chart-group-container {
              display: grid;
              grid-template-columns: repeat(1, minmax(0, 1fr));
              gap: 20px;
              width: 100%;
            }
        }
        .chart-container {
            min-height: 300px;
        }
    </style>
    <!-- Chart.js, axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="content">
    <div class="content-header">Admin Dashboard</div>
    <div class="content-body">
        <div id="question-list" class="question-list">
            <div class="linkDiv">
                <!-- 좌측: 통계 영역 -->
                <div class="statistics-section">
                    <!-- 차트 선택 UI: 카테고리 버튼 -->
                    <div class="chart-selector">
                        <button data-category="music">음원관련 통계</button>
                        <button data-category="tag">태그관련 통계</button>
                        <button data-category="user">유저관련 통계</button>
                        <!-- 수정페이지 버튼은 별도 -->
                        <button data-chart="editPage">수정페이지</button>
                    </div>
                    <!-- 카테고리별 차트 영역 -->
                    <div id="music-section" class="category-section">
                        <div class="chart-group-container">
                            <!-- 음원관련 차트들 -->
                            <div class="chart-container">
                                <canvas id="soundDoughnutChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="topSellingArtistsChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="topSellingMusicChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="topUploadArtistsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div id="tag-section" class="category-section">
                        <div class="chart-group-container">
                            <!-- 태그관련 차트들 -->
                            <div class="chart-container">
                                <canvas id="instrumentBarChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="moodBarChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="genreBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div id="user-section" class="category-section">
                        <div class="chart-group-container">
                            <!-- 유저관련 차트들 -->
                            <div class="chart-container">
                                <canvas id="userPieChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="subscriptionChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="recentChangeSubscriptionTable"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 우측: 수정페이지 영역 (자주 사용하는 기능 메뉴) -->
                <div class="frequently-list">
                    <li id="upload-sound">
                        <span class="main-text">음원 업로드</span><br>
                        <span class="sub-text">Album, Music, Instrument Tag, Mood Tag, Genre Tag</span>
                        <img src="/images/chevron_right_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg" alt="chevron">
                    </li>
                    <li id="edit-album">
                        <span class="main-text">앨범 정보 수정</span><br>
                        <span class="sub-text">Title, Description</span>
                        <img src="/images/chevron_right_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg" alt="chevron">
                    </li>
                    <li id="edit-music">
                        <span class="main-text">음원 정보 수정</span><br>
                        <span class="sub-text">Title, Description, soundType</span>
                        <img src="/images/chevron_right_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg" alt="chevron">
                    </li>
                    <li id="edit-tags">
                        <span class="main-text">태그 정보 수정</span><br>
                        <span class="sub-text">Instrument Tag, Mood Tag, Genre Tag</span>
                        <img src="/images/chevron_right_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg" alt="chevron">
                    </li>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript: 차트 생성 및 카테고리 전환 -->
<script type="module">
    import { axiosGet } from '/js/fetch/standardAxios.js';

    const ChartModule = (() => {
      const charts = {}; // 각 차트 인스턴스 저장

      // 카테고리 영역 숨김
      function hideAllCategorySections() {
        document.querySelectorAll('.category-section').forEach(section => {
          section.style.display = 'none';
        });
      }

      // 지정된 카테고리 영역 보이기
      function showCategorySection(category) {
        hideAllCategorySections();
        const section = document.getElementById(category + '-section');
        if (section) section.style.display = 'block';
      }

      // 각 차트 생성 시, 이미 생성된 차트가 있다면 destroy() 호출
      async function createSoundDoughnutChart() {
        try {
          const canvas = document.getElementById('soundDoughnutChart');
          if (charts["soundDoughnutChart"]) {
            charts["soundDoughnutChart"].destroy();
            delete charts["soundDoughnutChart"];
          }
          const soundsStats = await axiosGet({ endpoint: '/api/statistic/sounds/stats' });
          const ctx = canvas.getContext('2d');
          charts["soundDoughnutChart"] = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ['Total Albums', 'Total Musics'],
              datasets: [{
                data: [soundsStats.dto.totalAlbums, soundsStats.dto.totalMusics],
                backgroundColor: ['rgba(255, 159, 64, 0.6)', 'rgba(54, 162, 235, 0.6)'],
                borderColor: ['rgba(255, 159, 64, 1)', 'rgba(54, 162, 235, 1)'],
                borderWidth: 1
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false }
          });
        } catch (error) {
          console.error("Sound Doughnut Chart 생성 오류:", error);
        }
      }

      async function createTopSellingMusicChart() {
        try {
          const canvas = document.getElementById('topSellingMusicChart');
          if (charts["topSellingMusicChart"]) {
            charts["topSellingMusicChart"].destroy();
            delete charts["topSellingMusicChart"];
          }
          const soundsStats = await axiosGet({ endpoint: '/api/statistic/sounds/stats' });
          const data = soundsStats.dto.topSellingMusic;
          const ctx = canvas.getContext('2d');
          charts["topSellingMusicChart"] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.map(item => item.title),
              datasets: [{
                label: '음원 판매',
                data: data.map(item => item.count),
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        } catch (error) {
          console.error("Top Selling Music Chart 생성 오류:", error);
        }
      }

      async function createTopSellingArtistsChart() {
        try {
          const canvas = document.getElementById('topSellingArtistsChart');
          if (charts["topSellingArtistsChart"]) {
            charts["topSellingArtistsChart"].destroy();
            delete charts["topSellingArtistsChart"];
          }
          const soundsStats = await axiosGet({ endpoint: '/api/statistic/sounds/stats' });
          const data = soundsStats.dto.topArtistsBySales;
          const ctx = canvas.getContext('2d');
          charts["topSellingArtistsChart"] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.map(item => item.nickname),
              datasets: [{
                label: '음원 판매 아티스트',
                data: data.map(item => item.count),
                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        } catch (error) {
          console.error("Top Selling Artists Chart 생성 오류:", error);
        }
      }

      async function createTopUploadArtistsChart() {
        try {
          const canvas = document.getElementById('topUploadArtistsChart');
          if (charts["topUploadArtistsChart"]) {
            charts["topUploadArtistsChart"].destroy();
            delete charts["topUploadArtistsChart"];
          }
          const soundsStats = await axiosGet({ endpoint: '/api/statistic/sounds/stats' });
          const data = soundsStats.dto.topArtistsByUploads;
          const ctx = canvas.getContext('2d');
          charts["topUploadArtistsChart"] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.map(item => item.nickname),
              datasets: [{
                label: '음원 업로드 아티스트',
                data: data.map(item => item.count),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true } } }
          });
        } catch (error) {
          console.error("Top Upload Artists Chart 생성 오류:", error);
        }
      }

      async function createInstrumentBarChart() {
        try {
          const canvas = document.getElementById('instrumentBarChart');
          if (charts["instrumentBarChart"]) {
            charts["instrumentBarChart"].destroy();
            delete charts["instrumentBarChart"];
          }
          const tagsStats = await axiosGet({ endpoint: '/api/statistic/tags/stats' });
          const data = tagsStats.dto.instrumentUsageCount;
          const ctx = canvas.getContext('2d');
          charts["instrumentBarChart"] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.map(item => item.tagName),
              datasets: [{
                label: '악기 태그 사용 통계',
                data: data.map(item => item.count),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true } } }
          });
        } catch (error) {
          console.error("Instrument Bar Chart 생성 오류:", error);
        }
      }

      async function createMoodBarChart() {
        try {
          const canvas = document.getElementById('moodBarChart');
          if (charts["moodBarChart"]) {
            charts["moodBarChart"].destroy();
            delete charts["moodBarChart"];
          }
          const tagsStats = await axiosGet({ endpoint: '/api/statistic/tags/stats' });
          const data = tagsStats.dto.moodUsageCount;
          const ctx = canvas.getContext('2d');
          charts["moodBarChart"] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.map(item => item.tagName),
              datasets: [{
                label: '무드 태그 사용 통계',
                data: data.map(item => item.count),
                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true } } }
          });
        } catch (error) {
          console.error("Mood Bar Chart 생성 오류:", error);
        }
      }

      async function createGenreBarChart() {
        try {
          const canvas = document.getElementById('genreBarChart');
          if (charts["genreBarChart"]) {
            charts["genreBarChart"].destroy();
            delete charts["genreBarChart"];
          }
          const tagsStats = await axiosGet({ endpoint: '/api/statistic/tags/stats' });
          const data = tagsStats.dto.genreUsageCount;
          const ctx = canvas.getContext('2d');
          charts["genreBarChart"] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.map(item => item.tagName),
              datasets: [{
                label: '장르 태그 사용 통계',
                data: data.map(item => item.count),
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true } } }
          });
        } catch (error) {
          console.error("Genre Bar Chart 생성 오류:", error);
        }
      }

      async function createUserPieChart() {
        try {
          const canvas = document.getElementById('userPieChart');
          if (charts["userPieChart"]) {
            charts["userPieChart"].destroy();
            delete charts["userPieChart"];
          }
          const usersStat = await axiosGet({ endpoint: '/api/statistic/users/stats' });
          const ctx = canvas.getContext('2d');
          charts["userPieChart"] = new Chart(ctx, {
            type: 'pie',
            data: {
              labels: ['전체 회원','신규 회원(today)','신규 회원(week)','신규 회원(Month)','구독제 가입 유저','이메일 인증 유저'],
              datasets: [{
                data: [
                  usersStat.dto.totalUsers,
                  usersStat.dto.newUsersToday,
                  usersStat.dto.nwUsersWeek,
                  usersStat.dto.newUsersMonth,
                  usersStat.dto.subscribedUsers,
                  usersStat.dto.verifiedUsers
                ],
                backgroundColor: [
                  'rgba(255, 99, 132, 0.6)',
                  'rgba(54, 162, 235, 0.6)',
                  'rgba(255, 206, 86, 0.6)',
                  'rgba(75, 192, 192, 0.6)',
                  'rgba(153, 102, 255, 0.6)',
                  'rgba(255, 159, 64, 0.6)'
                ],
                borderColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 206, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false }
          });
        } catch (error) {
          console.error("User Pie Chart 생성 오류:", error);
        }
      }

      async function createSubscriptionChart() {
        try {
          const canvas = document.getElementById('subscriptionChart');
          if (charts["subscriptionChart"]) {
            charts["subscriptionChart"].destroy();
            delete charts["subscriptionChart"];
          }
          const userSubscriptionStats = await axiosGet({ endpoint: '/api/statistic/subscription/stats' });
          const data = userSubscriptionStats.dto.subscriptionStatisticDTO;
          const ctx = canvas.getContext('2d');
          charts["subscriptionChart"] = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.map(item => item.subscriptionName),
              datasets: [{
                label: '예상 월간 수익',
                data: data.map(item => item.monthlyRevenue),
                backgroundColor: 'rgba(255, 205, 86, 0.6)',
                borderColor: 'rgba(255, 205, 86, 1)',
                borderWidth: 1
              }]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true } } }
          });
        } catch (error) {
          console.error("Subscription Chart 생성 오류:", error);
        }
      }

      function resizeCharts() {
        Object.values(charts).forEach(chart => chart.resize());
      }

      return {
        charts,
        showCategorySection,
        resizeCharts,
        createSoundDoughnutChart,
        createTopSellingMusicChart,
        createTopSellingArtistsChart,
        createTopUploadArtistsChart,
        createInstrumentBarChart,
        createMoodBarChart,
        createGenreBarChart,
        createUserPieChart,
        createSubscriptionChart
      };
    })();

    // 이벤트 처리: 카테고리 버튼과 수정페이지 버튼
    document.querySelectorAll('.chart-selector button').forEach(btn => {
      btn.addEventListener('click', async () => {
        // 모든 버튼 active 제거
        document.querySelectorAll('.chart-selector button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // 수정페이지 버튼이면 통계 영역 숨기고 수정 메뉴 표시
        if (btn.getAttribute('data-chart') === 'editPage') {
          document.querySelectorAll('.category-section').forEach(sec => sec.style.display = 'none');
          document.querySelector('.frequently-list').style.display = 'block';
          return;
        } else {
          document.querySelector('.frequently-list').style.display = 'none';
        }

        // 카테고리 버튼인 경우
        const category = btn.getAttribute('data-category');
        if (category) {
          ChartModule.showCategorySection(category);
          if (category === 'music') {
            await ChartModule.createSoundDoughnutChart();
            await ChartModule.createTopSellingArtistsChart();
            await ChartModule.createTopSellingMusicChart();
            await ChartModule.createTopUploadArtistsChart();
          } else if (category === 'tag') {
            await ChartModule.createInstrumentBarChart();
            await ChartModule.createMoodBarChart();
            await ChartModule.createGenreBarChart();
          } else if (category === 'user') {
            await ChartModule.createUserPieChart();
            await ChartModule.createSubscriptionChart();
          }
        }
      });
    });

    // 기본: 페이지 로딩 시 "음원관련 통계" 그룹 활성화
    (async () => {
      const defaultBtn = document.querySelector('button[data-category="music"]');
      if (defaultBtn) defaultBtn.classList.add('active');
      ChartModule.showCategorySection('music');
      await ChartModule.createSoundDoughnutChart();
      await ChartModule.createTopSellingArtistsChart();
      await ChartModule.createTopSellingMusicChart();
      await ChartModule.createTopUploadArtistsChart();
    })();

    window.addEventListener('resize', ChartModule.resizeCharts);
</script>
</body>
</html>
