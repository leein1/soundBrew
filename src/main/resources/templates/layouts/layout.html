<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
    <link th:href="@{/css/layout.css}" rel="stylesheet">
    <link th:href="@{/css/darkmode.css}" rel="stylesheet">
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="main">

        <div class="sidebar">
            <div class="menu">
                <img class="menu-icon" th:src="@{/images/menu_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
            </div>

            <hr class="divider">

            <div class="guest-view">
                <div class="profile">
                    <img th:src="@{/images/account_circle_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}" alt="User Profile" class="profile-image">
                    <button class="primary-button none-display">로그인</button>
                </div>
            </div>

            <div class="user-view" style="display: none;">
                <div class="profile" >
                    <img th:src="@{/images/account_circle_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}" alt="User Profile" class="profile-image">
<!--                    <button class="primary-button none-display" onclick="openModal('profile-modal')" >프로필 사진 변경</button>-->
                    <button id="profileModalBtn" class="primary-button none-display" data-modal="profile-modal" style="display:none">프로필 사진 변경</button>
                </div>

                <div class="info1">
                    <span class="myNickName" id="myNickName" >닉네임</span>
                    <span class="plans" >BASIC</span>
                </div>

                <div class="info2" >
                    <span class="credit" >100C</span>
                    <span class="subscription" >구독제</span>
                </div>
            </div>

            <hr class="divider">

            <div class="sidebar-item">
                <img class="sidebar-icon" th:src="@{/images/music_note_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                <span class="sidebar-text" id="soundTracksRoute">곡</span>
            </div>

            <div class="sidebar-item">
                <img class="sidebar-icon" th:src="@{/images/graphic_eq_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                <span class="sidebar-text">효과음</span>
            </div>

            <hr class="divider">

            <div class="user-view" style="display: none;">
                <div class="sidebar-my-info">
                    <!-- 타이틀 영역 (클릭하면 펼쳐짐) -->
                    <div class="sidebar-my-info-title">
                        <div class="sidebar-item">
                            <img class="sidebar-icon" th:src="@{/images/info_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                            <span class="sidebar-text" id="myMore">더 보기</span>
                        </div>
                    </div>

                    <!-- 펼쳐질 내부 내용 -->
                    <div class="user-view-content">
                        <div class="sidebar-item">
                            <img class="sidebar-icon" th:src="@{/images/psychology_alt_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                            <span class="sidebar-text" id="myInfoRoute">내 정보 조회</span>
                        </div>
                        <div class="sidebar-item">
                            <img class="sidebar-icon" th:src="@{/images/subscriptions_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                            <span class="sidebar-text" id="mySubscriptionRoute">내 구독 정보 조회</span>
                        </div>
                        <div class="sidebar-item">
                            <img class="sidebar-icon" th:src="@{/images/album_48dp_5F6368_FILL0_wght400_GRAD0_opsz48.svg}">
                            <span class="sidebar-text" id="myAlbumsRoute">내 앨범 조회</span>
                        </div>
                        <div class="sidebar-item">
                            <img class="sidebar-icon" th:src="@{/images/music_note_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                            <span class="sidebar-text" id="myTracksRoute">내 음원 조회</span>
                        </div>
                    </div>
                </div>
            </div>
            <hr class="divider">
            
            <div class="sidebar-item">
                <img class="sidebar-icon" th:src="@{/images/help_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                <span class="sidebar-text">문의</span>
            </div>

            <div class="toggle-container">
                <img th:src="@{/images/light_mode_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                <input type="checkbox" id="darkModeToggle" class="darkMode-checkbox">
                <label for="darkModeToggle" class="darkMode-label"></label>
                <img th:src="@{/images/dark_mode_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                </label>
            </div>
        </div> <!-- end sidebar -->

        <div class="article">
            <div class="navigation">
                <div class="navigation-menu">
                    <img class="navigation-menu-icon" th:src="@{/images/menu_24dp_5F6368_FILL0_wght400_GRAD0_opsz24.svg}">
                </div>
                <div class="sitename font-size-small" id="sitename"><img src="/images/SoundBrew.svg"></div>

                <div class="guest-view">
                    <div class="user">회원가입</div>
                </div>
                <div class="user-view">
                    <div class="user">로그아웃</div>
                </div>

            </div><!-- end navigation -->
            <div id="searchContainer" class="searchContainer"></div>
            <div class="content" layout:fragment="content">
                <span class="play-trigger" style="cursor: pointer; color: blue;">재생</span>
            </div><!-- end content -->
            <div class="pagination-container" id="pagination-container"></div>
            <div class="footer">
                푸터 영역
            </div><!-- end footer -->
        </div><!-- end article -->
    </div><!-- end main -->
    
    <!-- 다크모드 js -->
    <script th:src="@{/js/darkmode.js}"></script>

    <!-- 사이드바 확장 js -->
    <script th:src="@{/js/sidebarExpand.js}"></script>

    <!-- 검색바 기능 -->
    <script src="/js/search.js"></script>

    <script type="module">
        import { router } from '/js/router.js';

        // function openModal(modalId) {
        //     const modal = document.getElementById(modalId);
        //     if (modal) {
        //         modal.style.display = 'flex';
        //     }
        // }
        //
        // function closeModal(modalId) {
        //     const modal = document.getElementById(modalId);
        //     if (modal) {
        //         modal.style.display = 'none';
        //     }
        // }

        document.addEventListener("DOMContentLoaded", () => {
    function base64UrlToBase64(base64Url) {
        // Base64 URL-safe 형식을 표준 Base64 형식으로 변환
        let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        // 필요한 패딩 추가 (문자열 길이가 4의 배수가 되도록)
        while (base64.length % 4) {
            base64 += '=';
        }
        return base64;
    }

    const token = localStorage.getItem("accessToken");

        if (token) {
            // JWT는 "HEADER.PAYLOAD.SIGNATURE" 형식입니다.
            const payloadBase64Url = token.split('.')[1];  // URL-safe 형식의 payload 추출
            const payloadBase64 = base64UrlToBase64(payloadBase64Url); // 표준 Base64로 변환
            const payloadDecoded = JSON.parse(atob(payloadBase64)); // Base64 디코딩 후 JSON 변환

            console.log("Decoded Token Payload:", payloadDecoded);

            // 값 개별적으로 접근
            console.log("닉네임:", payloadDecoded.nickname);
            const myNickName = document.getElementById('myNickName');
            myNickName.innerText = payloadDecoded.nickname;
            console.log("만료 시간 (exp):", new Date(payloadDecoded.exp * 1000).toLocaleString("ko-KR"));
            console.log("발급 시간 (iat):", new Date(payloadDecoded.iat * 1000).toLocaleString("ko-KR"));
            console.log("사용자 ID:", payloadDecoded.userId);
            console.log("이메일:", payloadDecoded.username);
            console.log("역할:", payloadDecoded.roles);
        } else {
            console.log("토큰이 없습니다.");
        }

        // 로그인 상태에 따른 화면 전환
        const isLoggedIn = localStorage.getItem("accessToken");

        if (isLoggedIn) {
            const guestViews = document.querySelectorAll('.guest-view');
            const userViews = document.querySelectorAll('.user-view');

            guestViews.forEach(view => {
                view.style.display = "none";
            });

            userViews.forEach(view => {
                view.style.display = "block";
            });
        }

        document.querySelector('#soundTracksRoute').addEventListener('click', () => {
            window.location.href = '/sounds/tracks';
        });

        document.querySelector('#myTracksRoute').addEventListener('click', () => {
            window.location.href = '/me/sounds/tracks';
        });

        document.querySelector('#myAlbumsRoute').addEventListener('click', () => {
            window.location.href = '/me/sounds/albums';
        });

        document.querySelector('#myInfoRoute').addEventListener('click', () => {
            window.location.href = '/me/info';
        });

        document.querySelector('#mySubscriptionRoute').addEventListener('click', () => {
            window.location.href = '/me/info';
        });

        // sitename 클릭 이벤트
        document.getElementById("sitename").addEventListener("click", () => {
            window.location.href = "/sounds/tracks";
        });
    });

    </script>


    <th:block layout:fragment="script">
</th:block>
</body>
</html>
